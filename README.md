# In-Memory Order Book - BTCZAR

## Overview
### **NOTE:** I have no prior experience with Kotlin — this is my first attempt at writing a Kotlin project.
This project implements a simple **in-memory order book** for the BTC/ZAR trading pair.  
It supports submitting **limit orders**, **order matching**, viewing all **open orders**, and retrieving **recent trades**.

The project is implemented in **Kotlin** using **Spring Boot**, focusing on clean, clear, and maintainable code.

---

## Features
- **Submit Limit Orders:** Place BUY or SELL orders with a specific price and quantity.
- **Order Matching:** Incoming orders match against opposite-side orders if prices overlap.
- **View Order Book:** Retrieve the current open bids and asks.
- **Recent Trades:** Retrieve the last 5 executed trades.
- **Validation:** Ensures orders have valid price, quantity, and currency pair.
- **Basic Authentication:** Secure endpoints using in-memory user credentials for testing via Postman.

---

## Endpoints

| Method | URL | Description |
|--------|-----|-------------|
| GET | `/api/BTCZAR/orderbook` | Returns the current order book |
| POST | `/api/orders/limit` | Submit a limit order (BUY or SELL) |
| GET | `/api/BTCZAR/tradehistory` | Returns the last 5 trades |

---

## Security Configuration

This project uses **Spring Security** with **in-memory authentication** for secure testing in Postman.

### Configuration Files
The following classes handle authentication and authorization:

#### `SecurityConfig.kt`
- Defines which endpoints are secured or public.
- Uses HTTP Basic Authentication.
- Disables CSRF for testing convenience.
- Configures password encryption using `BCryptPasswordEncoder`.

#### `InMemoryUserConfig.kt`
- Creates an in-memory user for authentication.
- Uses `PasswordEncoder` to securely hash the password.

**Postman Setup Example:**
1. Go to the **Authorization** tab.
2. Select **Basic Auth**.
3. Enter:
    - Username: `trader1`
    - Password: `password123`
4. Test the protected endpoint:

---

## How to Run

### Prerequisites
- Java 17+
- Maven 3.8+
- GitHub Codespaces or local IDE
- Postman for API testing

### Running the Application:
#### Codespaces:
1. Navigate to codespaces on git and open project (Using main branch)
2. Once project is loaded, open terminal and run:
```bash
# Build the project
mvn clean install

# Run the Spring Boot application
c
```
3. The port should be forwarded to 8080 automatically BUT it should be changed to visibility = public. To do this:
    - Click on the "Ports" tab at the bottom of the Codespaces window.
    - Find port 8080 in the list.
    - Right Click on the port entry of 8080 and select port visibility "Public".
#### The API server will start on something similar to https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/

### Manual Testing with Postman
#### User Credentials (for Postman) - Add to Basic Auth Type
| Username | Password | Role |
|-----------|-----------|------|
| `trader1` | `password123` | `USER` |

#### Endpoint Access Rules
| Endpoint | Authentication Required | Description |
|-----------|-------------------------|-------------|
| `/api/orders/limit` | Yes                     | Requires Basic Auth |
| `/api/BTCZAR/orderbook` | No                      | Public |
| `/api/BTCZAR/tradehistory` | No                      | Public |

### STEP 1: View Initial Order Book (Returns initial dummy data)
#### Request
GET https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/BTCZAR/orderbook

#### Expected Response:
````
{
"bids": [
{ "side": "BUY", "quantity": "0.196", "price": "1875206", "currencyPair": "BTCZAR", "orderCount": 1 },
{ "side": "BUY", "quantity": "0.02802465", "price": "1875206", "currencyPair": "BTCZAR", "orderCount": 1 }
],
"asks": [
{ "side": "SELL", "quantity": "0.075", "price": "1878404", "currencyPair": "BTCZAR", "orderCount": 1 },
{ "side": "SELL", "quantity": "0.14071953", "price": "1878405", "currencyPair": "BTCZAR", "orderCount": 1 }
],
"sequenceNumber": 18515253075
}
````


#### STEP 2: Submit a SELL Limit Order that doesn't match immediately. (i.e., price higher than top BUY)
#### Request (Auth Required)
POST https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/orders/limit

#### Body:
````
{
  "side": "SELL",
  "quantity": "0.05",
  "price": "1878500",
  "pair": "BTCZAR",
  "customerOrderId": "SELL-001"
}
````

#### Expected Response:
````
{
  "orderId": "<auto-generated-or-UUID>",
  "customerOrderId": "SELL-001"
}
````
Explanation:
- No BUY order at or above 1,878,500 so it's not matched.
- New SELL order gets added to asks list.

#### STEP 3: Submit a BUY Order that Triggers a Match. (i.e., price >= best SELL price)
#### Request (Auth Required)
POST https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/orders/limit

#### Body:
````
{
  "side": "BUY",
  "quantity": "0.05",
  "price": "1878404",
  "pair": "BTCZAR",
  "customerOrderId": "BUY-001"
}
````

#### Expected Response:
````
{
  "orderId": "<auto-generated-or-UUID>",
  "customerOrderId": "BUY-001"
}
````
Explanation:
- Matches with top SELL at 1878404
- Trade is created
- SELL order at 1878404 reduces from 0.075 -> 0.025 remaining.
- New BUY order not added to book (fully matched).

#### STEP 4: Check Updated Order Book
#### Request 
GET https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/BTCZAR/orderbook

#### Expected Response:
````
{
  "bids": [
    { "side": "BUY", "quantity": "0.196", "price": "1875206", "currencyPair": "BTCZAR", "orderCount": 1 },
    { "side": "BUY", "quantity": "0.02802465", "price": "1875206", "currencyPair": "BTCZAR", "orderCount": 1 }
  ],
  "asks": [
    { "side": "SELL", "quantity": "0.025", "price": "1878404", "currencyPair": "BTCZAR", "orderCount": 1 },
    { "side": "SELL", "quantity": "0.14071953", "price": "1878405", "currencyPair": "BTCZAR", "orderCount": 1 },
    { "side": "SELL", "quantity": "0.05", "price": "1878500", "currencyPair": "BTCZAR", "orderCount": 1 }
  ],
  "LastChange": "2025-10-19T11:11:49.346803300Z",
  "sequenceNumber": 18515253075
}

````

#### STEP 5: Retrieve Recent Trades
#### Request
GET https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/BTCZAR/tradehistory

#### Expected Response:
````
[
    {
        "id": "7b7fd51e-d558-4b3a-bc0c-bcd545d1e6b6",
        "price": 1878404,
        "quantity": 0.05,
        "currencyPair": "BTCZAR",
        "tradedAt": "2025-10-19T11:11:37.843346300Z",
        "takerSide": "buy",
        "sequenceId": 1370000000002671001,
        "quoteVolume": 93920.20
    }
]
````

## Error / Validation Test Scenarios
#### Submit Without Auth (Negative)
POST https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/orders/limit  (No auth header)

Expected
- 401 Unauthorized

#### Negative Price (OrderValidationException)
POST https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/orders/limit

#### Body:
````
{
  "side": "BUY",
  "quantity": "0.1",
  "price": "-10",
  "pair": "BTCZAR",
  "customerOrderId": "ERR-PRICE"
}
````

#### Expected Response:
````
{
  "timestamp": "2025-10-19T12:00:00Z",
  "message": "Order price must be greater than zero",
  "status": 400
}
````

#### Zero Quantity (OrderValidationException)
POST https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/orders/limit

#### Body:
````
{
  "side": "SELL",
  "quantity": "0",
  "price": "1878404",
  "pair": "BTCZAR",
  "customerOrderId": "ERR-QUANTITY"
}

````

#### Expected Response:
````
{
  "timestamp": "2025-10-19T12:00:00Z",
  "message": "Order quantity must be greater than zero",
  "status": 400
}

````

#### Invalid Pair (Exception / IllegalArgumentException)
POST https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/orders/limit

#### Body:
````
{
  "side": "BUY",
  "quantity": "0.1",
  "price": "100",
  "pair": "INVALIDPAIR",
  "customerOrderId": "ERR-PAIR"
}

````

#### Expected Response:
````
{
  "timestamp": "2025-10-19T12:00:00Z",
  "message": "No enum constant orderbook.model.enum.Pair.INVALIDPAIR",
  "status": 500
}

````

#### Missing Field (General Exception)
POST https://animated-space-cod-75p47grjg6r297r-8080.app.github.dev/api/orders/limit

#### Body:
````
{
  "side": "BUY",
  "price": "1878404",
  "pair": "BTCZAR"
}

````

#### Expected Response:
````
{
  "timestamp": "2025-10-19T12:00:00Z",
  "message": "JSON parse error:",
  "status": 500
}
````

### Running Tests
#### Test reports are generated in target/surefire-reports.
#### 
```bash
# Run unit and integration tests
mvn test
```

#### Viewing Test Reports in Browser
```bash
#You can generate the HTML report directly on code spaces. Run the below
# command and open it directly in your browser:
mvn clean test surefire-report:report && cd target/reports && python3 -m http.server 8081

#Once opened, select surefire.html to review the report.
```

### Summary
#### This project demonstrates:
- Core trading logic (limit orders, matching engine)
- Simple in-memory data structures for an order book
- Clean and maintainable Kotlin code
- Unit and E2E tests verifying core functionality
- API endpoints similar to VALR’s BTCZAR endpoints

